from backend.app import orm
import pandas as pd
from ast import literal_eval

def get_video_data(video_id):
    session = orm.Session(orm.engine)
    res = session.get(orm.Clip, video_id)
    session.close()
    return res

def _prep_row(row):
    columns = ['', '_level', '_items', '_gold', 'Role', '_general_runes', 'Summoners']

    res_row = {}
    for typ in ['blue', 'red']:
        player = 'victim' if row['victim_side'] == typ else 'killer'
        for col in columns:
            res_row[f'{typ}{col}'] = row[f'{player}{col}']
        res_row['winner'] = 'blue' if row['victim_side'] == 'red' else 'red'
    return res_row

def _finalize_df(df):
    res_df = df.rename(columns={'redRole':'red_role', 'blueRole':'blue_role', 'red':'red_champion', 'blue':'blue_champion', 'blueSummoners':'blue_summoners', 'redSummoners':'red_summoners'})
    for color in ['red', 'blue']:
        res_df[f'{color}_items'] = res_df[f'{color}_items']
        res_df[f'{color}_general_runes'] = res_df[f'{color}_general_runes']
        res_df[f'{color}_summoners'] = res_df[f'{color}_summoners'].apply(lambda s: list(s.values()))
    return res_df

def prepare_rows_inference(video_ids):
    res_rows = []
    for video_id in video_ids:
        row = _prep_row(get_video_data(video_id).json_data)
        row['video_id'] = video_id
        res_rows.append(row)

    res_df = pd.DataFrame(res_rows)
    res_df = _finalize_df(res_df)
    res_df.to_parquet('inference_df.parquet')
    return res_df

def prepare_train_df(kills_df, out_path):
    res_rows = []
    for i, row in kills_df.iterrows():
        res_rows.append(_prep_row(row))

    res_df = pd.DataFrame(res_rows)
    res_df = _finalize_df(res_df)
    res_df_cloned = res_df.copy()
    res_df_cloned.columns = [k.replace('red', 'blue') if 'red' in k else k.replace('blue', 'red') for k in res_df.columns]
    res_df_cloned['winner'] = res_df_cloned['winner'].apply(lambda k: 'red' if k == 'blue' else 'blue')
    res_df = pd.concat([res_df, res_df_cloned[res_df.columns]]).sort_index()

    res_df.assign(blue_items=lambda df: df['blue_items'].apply(list)).assign(red_items=lambda df: df['red_items'].apply(list)).to_parquet(out_path, index=False)
    return res_df

# prepare_rows([789810125,789808921,789808855,789807469,789806683,789806660,789805590,789805181,789805142,789804221,789803916,789802746,789802566,789802407,789798166,789797079,789796497,789795678,789794723,789793871,789793830,789792460,789792458,789792450,789791125,789789939,789788671,789788052,789788010,789787980,789786795,789786063,789785334,789785307,789785259,789783909,789782479,789781664,789781454,789780511,789780527,789778786,789778058,789777993,789776761,789775852,789775411,789774340,789772808,789772254,789771285,789770763,789770220,789770129,789769314,789768080,789767081,789766674,789766612,789766440,789766052,789765983,789763423,789763009,789762296,789761920,789760463,789760051,789758057,789757046,789756224,789756188,789756190,789756108,789751970,789749802,789749265,789747939,789746111,789745296,789744730,789743320,789743287,789742265,789740899,789740891,789739750,789739013,789738347,789736545,789735115,789734702,789732870,789731791,789731118,789730633,789730153,789729623,789728997,789728308,789726773,789726181,789726109,789725301,789725247,789724001,789722618,789722334,789721117,789720515,789719719,789716792,789716782,789716754,789714325,789713103,789711939,789711929,789711238,789711232,789709891,789709098,789709080,789709037,789707394,789707221,789707159,789703751,789703730,789702743,789702156,789697136,789697069,789696144,789695792,789694811,789694581,789694049,789694016,789693404,789693405,789691891,789691151,789690200,789688992,789688896,789687759,789687742,789687437,789687284,789687207,789686968,789683489,789683454,789682712,789682266,789681262,789681224,789678391,789678244,789677184,789677141,789676196,789675416,789675332,789674221,789673924,789673142,789671788,789671121,789670480,789669801,789669796,789669768,789668312,789668304,789667418,789667032,789666143,789664792,789588037,789587824,789587628,789587501,789587494,789586979,789586481,789586286,789585781,789585649,789585309,789585298,789585022,789584987,789584912,789584372,789584154,789583120,789582469,789582315,789582317,789581774,789580333,789579597,789579166,789579147,789577792,789577753,789577062,789576714,789576498,789575960,789575449,789575444,789574953,789574956,789574909,789574907,789573992,789573581,789573041,789573046,789572399,789572040,789572036,789571671,789571267,789571229,789571166,789571153,789570380,789569851,789569421,789569161,789569135,789569068,789568446,789568383,789567777,789567454,789567430,789566893,789566885,789566459,789566107,789565282,789563527,789562982,789562560,789562410,789561759,789561174,789560640,789560454,789560444,789559803,789559758,789558857,789558781,789558792,789558695,789557967,789557954,789557160,789556902,789556705,789556551,789556330,789556082,789555830,789555807,789555340,789555130,789554556,789554162,789553948,789553520,789553346,789552970,789552400,789552394,789551722,789551476,789551247,789550985,789550841,789550418,789549484,789549244,789548786,789547585,789547578,789547246,789547017,789546491,789545928,789545750,789545675,789545266,789544963,789544941,789544167,789543863,789543380,789543195,789542964,789542735,789541966,789541528,789541394,789541205,789540804,789540512,789540009,789539980,789539118,789538921,789538642,789538588,789538158,789537860,789537439,789537275,789536723,789536580,789536574,789536232,789535637,789535362,789535334,789535326,789534850,789534812,789534790,789534786,789533759,789533580,789533134,789532937,789532542,789531996,789531723,789531672,789530404,789529893,789529706,789529523,789529443,789527900,789527875,789527272,789526564,789526193,789525930,789525637,789525249,789524536,789524417,789524385,789524377,789524257,789523163,789523142,789522127,789521945,789521826,789521803,789521697,789520452,789520102,789519439,789518857,789518585,789517972,789517926,789517272,789517257,789516430,789515860,789515591,789514748,789514725,789514208,789514202,789513304,789513064,789513076,789512427,789512265,789511947,789511927,789511379,789511349,789510755,789510518,789510250,789510035,789509892,789509883,789509308,789509292,789509295,789508697,789508687,789507742,789507715,789507673,789506820,789506616,789506565,789506542,789506495,789505365,789505353,789504552,789504196,789504182,789504122,789502714,789501980,789501465,789500390,789500089,789500063,789499288,789498841,789498189,789498162,789498147,789497346,789497046,789497053,789496498,789496493,789495852,789495596,789494079,789493842,789493557,789493084,789491026,789490928,789490917,789490897,789489674,789489108,789489078,789488541,789488526,789488529,789486977,789486928,789486236,789486020,789484802,789484794,789484788,789483621,789483543,789483555,789483524,789483470,789482182,789481801,789481420,789481359,789480666,789480062,789479574,789479001,789477929,789476972,789476513,789476283,789475375,789475162,789474810,789473797,789473779,789472896,789472392,789472325,789472250,789472238,789471224,789470862,789470327,789469747,789469740,789468793,789468749,789467571,789466811,789466754,789465525,789465096,789463656,789463639,789463150,789462491,789461950,789461898,789460789,789460533,789460329,789460043,789459722,789459537,789459472,789458851,789458844,789458372,789458105,789458033,789458024,789457043,789457022,789457003,789455827,789455664,789455569,789455476,789454906,789454913,789454904,789454875,789454016,789453982,789453937,789452863,789452510,789451896,789451529,789451033,789450636,789450430,789450127,789449818,789449811,789449331,789449299,789448189,789448187,789447558,789446342,789446071,789445859,789445417,789445197,789445119,789444228,789444075,789443906,789443898,789443882,789443861,789442934,789442886,789442832,789442081,789442066,789442043,789442034,789441950,789441072,789441050,789441026,789441001,789440936,789439991,789439965,789439630,789439463,789439176,789438556,789438360,789437914,789437702,789437523,789437410,789436800,789436132,789435903,789435902,789435848,789435150,789435156,789435106,789434473,789434448,789433688,789433662,789432973,789432779,789432728,789432714,789432649,789432612,789432547,789431917,789431909,789431356,789431342,789430698,789430465,789430288,789430289,789429715,789429463,789429294,789429091,789428468,789428381,789428180,789428020,789427857,789427659,789427354,789427112,789426872,789426556,789426538,789426072,789425888,789425559,789425139,789424740,789424542,789424445,789424435,789423834,789423615,789422363,789421784,789421640,789421246,789420920,789420778,789420761,789420272,789420261,789420238,789419606,789419117,789418804,789418223,789418210,789417689,789417427,789417202,789416588,789415639,789415536,789415538,789414796,789414403,789414030,789413806,789413417,789413221,789413062,789412668,789412549,789412048,789411843,789411794,789411742,789411146,789410892,789410413,789410406,789410369,789409739,789409643,789409421,789409361,789409005,789408960,789408900,789408408,789408216,789408166,789408167,789408142,789407599,789407469,789407314,789407169,789407041,789407038,789406619,789406614,789406604,789405714,789405655,789405652,789404710,789404517,789404436,789403930,789403824,789403798,789403524,789403194,789403134,789403097,789403070,789403034,789402450,789402420,789402028,789401896,789401656,789401644,789401193,789401039,789400988,789400981,789400685,789400534,789400394,789399969,789399941,789399583,789399571,789399370,789399042,789399036,789399019,789398698,789398702,789398291,789398258,789398234,789397842,789397629,789397541,789397525,789397157,789397031,789396969,789396955,789396622,789396511,789396257,789396231,789395886,789395695,789395609,789395207,789395095,789395057,789394733,789394644,789394094,789393951,789393794,789393197,789393194,789392866,789392860,789392812,789392028,789392034,789392021,789391985,789391353,789391311,789391310,789391056,789390446,789390311,789390038,789389980,789389562,789389360,789389352,789389000,789388823,789388787,789388776,789388561,789388558,789388529,789387845,789387569,789387420,789386945,789386851,789386751,789386741,789386680,789386116,789385915,789385510,789385497,789385269,789385194,789385193,789385191,789385181,789385156,789385165,789385123,789384169,789383995,789383990,789383848,789383624,789383519,789383363,789383048,789383037,789382505,789382382,789381798,789381757,789381503,789380952,789380378,789380256,789380114,789380090,789379526,789379212,789379069,789378923,789378856,789378558,789378316,789378250,789378232,789377878,789377856,789377464,789377198,789376905,789376622,789376560,789376546,789376202,789376080,789375694,789375688,789375685,789375645,789375155,789374882,789374696,789374486,789374205,789374003,789373889,789373791,789373793,789373588,789372855,789372560,789372434,789372409,789372206,789372187,789371674,789371547,789371452,789371357,789370707,789370564,789370210,789370115,789369752,789368835,789368734,789368268,789367751,789367553,789367023,789366195,789365857,789365787,789365767,789365121,789364823,789364691,789364325,789363744,789363591,789363509,789363486,789362848,789362695,789361674,789361084,789361032,789360768,789360755,789360709,789360056,789360005,789359994,789359465,789358892,789358656,789358269,789358260,789357566,789357567,789357020,789357013,789356707,789356509,789356392,789356207,789356186,789355732,789355319,789355269,789354932,789354731,789354586,789354134,789354074,789354060,789353502,789353232,789352823,789352796,789352552,789352550,789351680,789351425,789351391,789351380,789350591,789350585,789349910,789349911,789349336,789349149,789348218,789347801,789347508,789347469,789346887,789346851,789346223,789346195,789345350,789345162,789330634,789329981,789329788,789329556,789329533,789329098,789328894,789328885,789328402,789328184,789327461,789327455,789326091,789325887,789325864,789325353,789324803,789324374,789324164,789323767,789323746,789323084,789322653,789322493,789322476,789322076,789321629,789321400,789321231,789321215,789320849,789320639,789319973,789319820,789319687,789318877,789318886,789318322,789317990,789317483,789316878,789316766,789316771,789316074,789316055,789315718,789315716,789315691,789315651,789314739,789314174])
# prepare_train_df('prediction_model/kills_df_raw.parquet', 'kills_df_model_ready_v2.parquet')
